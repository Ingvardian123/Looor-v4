package com.uraniumcraft.commands;

import com.uraniumcraft.UraniumPlugin;
import com.uraniumcraft.items.UraniumTablet;
import net.kyori.adventure.text.Component;
import net.kyori.adventure.text.format.NamedTextColor;
import net.kyori.adventure.text.format.TextDecoration;
import org.bukkit.Bukkit;
import org.bukkit.command.Command;
import org.bukkit.command.CommandExecutor;
import org.bukkit.command.CommandSender;
import org.bukkit.command.TabCompleter;
import org.bukkit.entity.Player;
import org.bukkit.inventory.ItemStack;

import java.util.*;

public class TabletCommand implements CommandExecutor, TabCompleter {
    
    private final UraniumPlugin plugin;
    
    public TabletCommand(UraniumPlugin plugin) {
        this.plugin = plugin;
    }
    
    @Override
    public boolean onCommand(CommandSender sender, Command command, String label, String[] args) {
        if (args.length == 0) {
            showHelp(sender);
            return true;
        }
        
        switch (args[0].toLowerCase()) {
            case "give":
                return handleGiveCommand(sender, args);
            case "info":
                return handleInfoCommand(sender, args);
            case "energy":
                return handleEnergyCommand(sender, args);
            case "module":
                return handleModuleCommand(sender, args);
            case "upgrade":
                return handleUpgradeCommand(sender, args);
            case "reset":
                return handleResetCommand(sender, args);
            case "list":
                return handleListCommand(sender);
            case "help":
                showHelp(sender);
                return true;
            default:
                sender.sendMessage(Component.text("‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /tablet help", 
                    NamedTextColor.RED));
                return true;
        }
    }
    
    private boolean handleGiveCommand(CommandSender sender, String[] args) {
        if (!sender.hasPermission("uraniumcraft.tablet.give")) {
            sender.sendMessage(Component.text("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥—ã!", 
                NamedTextColor.RED));
            return true;
        }
        
        if (args.length < 3) {
            sender.sendMessage(Component.text("‚ùå –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /tablet give <–∏–≥—Ä–æ–∫> <—Ç–∏–ø> [—ç–Ω–µ—Ä–≥–∏—è]", 
                NamedTextColor.RED));
            sender.sendMessage(Component.text("–¢–∏–ø—ã: standard, advanced, quantum, reality", 
                NamedTextColor.GRAY));
            return true;
        }
        
        Player target = Bukkit.getPlayer(args[1]);
        if (target == null) {
            sender.sendMessage(Component.text("‚ùå –ò–≥—Ä–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω!", NamedTextColor.RED));
            return true;
        }
        
        UraniumTablet.TabletType type;
        try {
            type = UraniumTablet.TabletType.valueOf(args[2].toUpperCase());
        } catch (IllegalArgumentException e) {
            sender.sendMessage(Component.text("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ç–∏–ø –ø–ª–∞–Ω—à–µ—Ç–∞! –î–æ—Å—Ç—É–ø–Ω—ã–µ: standard, advanced, quantum, reality", 
                NamedTextColor.RED));
            return true;
        }
        
        int energy = type.getMaxEnergy();
        if (args.length > 3) {
            try {
                energy = Integer.parseInt(args[3]);
                energy = Math.max(0, Math.min(energy, type.getMaxEnergy()));
            } catch (NumberFormatException e) {
                sender.sendMessage(Component.text("‚ùå –ù–µ–≤–µ—Ä–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ —ç–Ω–µ—Ä–≥–∏–∏!", NamedTextColor.RED));
                return true;
            }
        }
        
        ItemStack tablet = UraniumTablet.createTablet(plugin, type, energy, new HashSet<>());
        target.getInventory().addItem(tablet);
        
        sender.sendMessage(Component.text("‚úÖ –ü–ª–∞–Ω—à–µ—Ç '" + type.getDisplayName() + "' –≤—ã–¥–∞–Ω –∏–≥—Ä–æ–∫—É " + target.getName(), 
            NamedTextColor.GREEN));
        target.sendMessage(Component.text("üì± –í—ã –ø–æ–ª—É—á–∏–ª–∏ " + type.getDisplayName() + "!", 
            type.getColor(), TextDecoration.BOLD));
        
        return true;
    }
    
    private boolean handleInfoCommand(CommandSender sender, String[] args) {
        if (!(sender instanceof Player player)) {
            sender.sendMessage(Component.text("‚ùå –≠—Ç–∞ –∫–æ–º–∞–Ω–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –∏–≥—Ä–æ–∫–∞–º!", NamedTextColor.RED));
            return true;
        }
        
        ItemStack item = player.getInventory().getItemInMainHand();
        if (!UraniumTablet.isUraniumTablet(item, plugin)) {
            sender.sendMessage(Component.text("‚ùå –í–æ–∑—å–º–∏—Ç–µ –ø–ª–∞–Ω—à–µ—Ç –≤ —Ä—É–∫—É!", NamedTextColor.RED));
            return true;
        }
        
        UraniumTablet.TabletType type = UraniumTablet.getTabletType(item, plugin);
        int energy = UraniumTablet.getTabletEnergy(item, plugin);
        Set<UraniumTablet.TabletModule> modules = UraniumTablet.getTabletModules(item, plugin);
        
        sender.sendMessage(Component.text("üì± –ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –ü–õ–ê–ù–®–ï–¢–ï", NamedTextColor.AQUA, TextDecoration.BOLD));
        sender.sendMessage(Component.text("‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ", NamedTextColor.DARK_GRAY));
        sender.sendMessage(Component.text("–¢–∏–ø: " + (type != null ? type.getDisplayName() : "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"), 
            type != null ? type.getColor() : NamedTextColor.GRAY));
        sender.sendMessage(Component.text("–≠–Ω–µ—Ä–≥–∏—è: " + energy + " / " + (type != null ? type.getMaxEnergy() : "?"), 
            getEnergyColor(energy, type != null ? type.getMaxEnergy() : 1000)));
        sender.sendMessage(Component.text("–ú–æ–¥—É–ª–µ–π —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ: " + modules.size(), NamedTextColor.YELLOW));
        
        if (!modules.isEmpty()) {
            sender.sendMessage(Component.text("–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏:", NamedTextColor.GOLD));
            for (UraniumTablet.TabletModule module : modules) {
                sender.sendMessage(Component.text("  ‚Ä¢ " + module.getName(), NamedTextColor.WHITE));
            }
        }
        
        int regenRate = type != null ? UraniumTablet.getEnergyRegenRate(type, modules) : 0;
        sender.sendMessage(Component.text("–†–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è —ç–Ω–µ—Ä–≥–∏–∏: +" + regenRate + "/30—Å–µ–∫", NamedTextColor.GREEN));
        sender.sendMessage(Component.text("‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ", NamedTextColor.DARK_GRAY));
        
        return true;
    }
    
    private boolean handleEnergyCommand(CommandSender sender, String[] args) {
        if (!sender.hasPermission("uraniumcraft.tablet.energy")) {
            sender.sendMessage(Component.text("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥—ã!", 
                NamedTextColor.RED));
            return true;
        }
        
        if (args.length < 2) {
            sender.sendMessage(Component.text("‚ùå –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /tablet energy <set|add|remove> [–∏–≥—Ä–æ–∫] <–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ>", 
                NamedTextColor.RED));
            return true;
        }
        
        String action = args[1].toLowerCase();
        Player target;
        int amount;
        
        if (args.length == 3) {
            // /tablet energy <action> <amount>
            if (!(sender instanceof Player)) {
                sender.sendMessage(Component.text("‚ùå –£–∫–∞–∂–∏—Ç–µ –∏–≥—Ä–æ–∫–∞!", NamedTextColor.RED));
                return true;
            }
            target = (Player) sender;
            try {
                amount = Integer.parseInt(args[2]);
            } catch (NumberFormatException e) {
                sender.sendMessage(Component.text("‚ùå –ù–µ–≤–µ—Ä–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ!", NamedTextColor.RED));
                return true;
            }
        } else if (args.length == 4) {
            // /tablet energy <action> <player> <amount>
            target = Bukkit.getPlayer(args[2]);
            if (target == null) {
                sender.sendMessage(Component.text("‚ùå –ò–≥—Ä–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω!", NamedTextColor.RED));
                return true;
            }
            try {
                amount = Integer.parseInt(args[3]);
            } catch (NumberFormatException e) {
                sender.sendMessage(Component.text("‚ùå –ù–µ–≤–µ—Ä–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ!", NamedTextColor.RED));
                return true;
            }
        } else {
            sender.sendMessage(Component.text("‚ùå –ù–µ–≤–µ—Ä–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤!", NamedTextColor.RED));
            return true;
        }
        
        ItemStack tablet = target.getInventory().getItemInMainHand();
        if (!UraniumTablet.isUraniumTablet(tablet, plugin)) {
            sender.sendMessage(Component.text("‚ùå –£ –∏–≥—Ä–æ–∫–∞ –Ω–µ—Ç –ø–ª–∞–Ω—à–µ—Ç–∞ –≤ —Ä—É–∫–µ!", NamedTextColor.RED));
            return true;
        }
        
        UraniumTablet.TabletType type = UraniumTablet.getTabletType(tablet, plugin);
        int currentEnergy = UraniumTablet.getTabletEnergy(tablet, plugin);
        int newEnergy = currentEnergy;
        
        switch (action) {
            case "set":
                newEnergy = Math.max(0, Math.min(amount, type != null ? type.getMaxEnergy() : 1000));
                break;
            case "add":
                newEnergy = Math.min(currentEnergy + amount, type != null ? type.getMaxEnergy() : 1000);
                break;
            case "remove":
                newEnergy = Math.max(0, currentEnergy - amount);
                break;
            default:
                sender.sendMessage(Component.text("‚ùå –ù–µ–≤–µ—Ä–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ! –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ: set, add, remove", 
                    NamedTextColor.RED));
                return true;
        }
        
        UraniumTablet.setTabletEnergy(tablet, plugin, newEnergy);
        
        sender.sendMessage(Component.text("‚úÖ –≠–Ω–µ—Ä–≥–∏—è –ø–ª–∞–Ω—à–µ—Ç–∞ –∏–∑–º–µ–Ω–µ–Ω–∞: " + currentEnergy + " ‚Üí " + newEnergy, 
            NamedTextColor.GREEN));
        
        if (!sender.equals(target)) {
            target.sendMessage(Component.text("‚ö° –≠–Ω–µ—Ä–≥–∏—è –≤–∞—à–µ–≥–æ –ø–ª–∞–Ω—à–µ—Ç–∞ –∏–∑–º–µ–Ω–µ–Ω–∞: " + newEnergy, 
                NamedTextColor.YELLOW));
        }
        
        return true;
    }
    
    private boolean handleModuleCommand(CommandSender sender, String[] args) {
        if (!sender.hasPermission("uraniumcraft.tablet.module")) {
            sender.sendMessage(Component.text("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥—ã!", 
                NamedTextColor.RED));
            return true;
        }
        
        if (args.length < 3) {
            sender.sendMessage(Component.text("‚ùå –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /tablet module <add|remove|list> [–∏–≥—Ä–æ–∫] [–º–æ–¥—É–ª—å]", 
                NamedTextColor.RED));
            return true;
        }
        
        String action = args[1].toLowerCase();
        
        if (action.equals("list")) {
            showModulesList(sender);
            return true;
        }
        
        Player target;
        if (args.length >= 4) {
            target = Bukkit.getPlayer(args[2]);
            if (target == null) {
                sender.sendMessage(Component.text("‚ùå –ò–≥—Ä–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω!", NamedTextColor.RED));
                return true;
            }
        } else {
            if (!(sender instanceof Player)) {
                sender.sendMessage(Component.text("‚ùå –£–∫–∞–∂–∏—Ç–µ –∏–≥—Ä–æ–∫–∞!", NamedTextColor.RED));
                return true;
            }
            target = (Player) sender;
        }
        
        ItemStack tablet = target.getInventory().getItemInMainHand();
        if (!UraniumTablet.isUraniumTablet(tablet, plugin)) {
            sender.sendMessage(Component.text("‚ùå –£ –∏–≥—Ä–æ–∫–∞ –Ω–µ—Ç –ø–ª–∞–Ω—à–µ—Ç–∞ –≤ —Ä—É–∫–µ!", NamedTextColor.RED));
            return true;
        }
        
        if (args.length < (args.length >= 4 ? 4 : 3)) {
            sender.sendMessage(Component.text("‚ùå –£–∫–∞–∂–∏—Ç–µ –º–æ–¥—É–ª—å!", NamedTextColor.RED));
            return true;
        }
        
        String moduleName = args[args.length >= 4 ? 3 : 2].toUpperCase();
        UraniumTablet.TabletModule module;
        
        try {
            module = UraniumTablet.TabletModule.valueOf(moduleName);
        } catch (IllegalArgumentException e) {
            sender.sendMessage(Component.text("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –º–æ–¥—É–ª—å! –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /tablet module list –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞", 
                NamedTextColor.RED));
            return true;
        }
        
        switch (action) {
            case "add":
                if (UraniumTablet.hasTabletModule(tablet, plugin, module)) {
                    sender.sendMessage(Component.text("‚ùå –ú–æ–¥—É–ª—å —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!", NamedTextColor.RED));
                } else {
                    UraniumTablet.addTabletModule(tablet, plugin, module);
                    sender.sendMessage(Component.text("‚úÖ –ú–æ–¥—É–ª—å '" + module.getName() + "' –¥–æ–±–∞–≤–ª–µ–Ω!", 
                        NamedTextColor.GREEN));
                    target.sendMessage(Component.text("üîß –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –º–æ–¥—É–ª—å: " + module.getName(), 
                        NamedTextColor.AQUA));
                }
                break;
            case "remove":
                if (!UraniumTablet.hasTabletModule(tablet, plugin, module)) {
                    sender.sendMessage(Component.text("‚ùå –ú–æ–¥—É–ª—å –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!", NamedTextColor.RED));
                } else {
                    // –õ–æ–≥–∏–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –º–æ–¥—É–ª—è (—Ç—Ä–µ–±—É–µ—Ç —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏)
                    sender.sendMessage(Component.text("‚úÖ –ú–æ–¥—É–ª—å '" + module.getName() + "' —É–¥–∞–ª–µ–Ω!", 
                        NamedTextColor.GREEN));
                    target.sendMessage(Component.text("üîß –£–¥–∞–ª–µ–Ω –º–æ–¥—É–ª—å: " + module.getName(), 
                        NamedTextColor.YELLOW));
                }
                break;
            default:
                sender.sendMessage(Component.text("‚ùå –ù–µ–≤–µ—Ä–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ! –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ: add, remove, list", 
                    NamedTextColor.RED));
                break;
        }
        
        return true;
    }
    
    private boolean handleUpgradeCommand(CommandSender sender, String[] args) {
        if (!sender.hasPermission("uraniumcraft.tablet.upgrade")) {
            sender.sendMessage(Component.text("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥—ã!", 
                NamedTextColor.RED));
            return true;
        }
        
        if (!(sender instanceof Player player)) {
            sender.sendMessage(Component.text("‚ùå –≠—Ç–∞ –∫–æ–º–∞–Ω–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –∏–≥—Ä–æ–∫–∞–º!", NamedTextColor.RED));
            return true;
        }
        
        ItemStack tablet = player.getInventory().getItemInMainHand();
        if (!UraniumTablet.isUraniumTablet(tablet, plugin)) {
            sender.sendMessage(Component.text("‚ùå –í–æ–∑—å–º–∏—Ç–µ –ø–ª–∞–Ω—à–µ—Ç –≤ —Ä—É–∫—É!", NamedTextColor.RED));
            return true;
        }
        
        UraniumTablet.TabletType currentType = UraniumTablet.getTabletType(tablet, plugin);
        if (currentType == null) {
            sender.sendMessage(Component.text("‚ùå –û—à–∏–±–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ç–∏–ø–∞ –ø–ª–∞–Ω—à–µ—Ç–∞!", NamedTextColor.RED));
            return true;
        }
        
        if (currentType == UraniumTablet.TabletType.REALITY) {
            sender.sendMessage(Component.text("‚ùå –ü–ª–∞–Ω—à–µ—Ç —É–∂–µ –∏–º–µ–µ—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å!", NamedTextColor.RED));
            return true;
        }
        
        UraniumTablet.TabletType nextType = UraniumTablet.TabletType.values()[currentType.ordinal() + 1];
        int currentEnergy = UraniumTablet.getTabletEnergy(tablet, plugin);
        Set<UraniumTablet.TabletModule> modules = UraniumTablet.getTabletModules(tablet, plugin);
        
        // –°–æ–∑–¥–∞–µ–º —É–ª—É—á—à–µ–Ω–Ω—ã–π –ø–ª–∞–Ω—à–µ—Ç
        ItemStack upgradedTablet = UraniumTablet.createTablet(plugin, nextType, currentEnergy, modules);
        player.getInventory().setItemInMainHand(upgradedTablet);
        
        sender.sendMessage(Component.text("‚úÖ –ü–ª–∞–Ω—à–µ—Ç —É–ª—É—á—à–µ–Ω –¥–æ —É—Ä–æ–≤–Ω—è: " + nextType.getDisplayName(), 
            nextType.getColor(), TextDecoration.BOLD));
        player.playSound(player.getLocation(), org.bukkit.Sound.UI_TOAST_CHALLENGE_COMPLETE, 1.0f, 1.2f);
        
        return true;
    }
    
    private boolean handleResetCommand(CommandSender sender, String[] args) {
        if (!sender.hasPermission("uraniumcraft.tablet.reset")) {
            sender.sendMessage(Component.text("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥—ã!", 
                NamedTextColor.RED));
            return true;
        }
        
        Player target;
        if (args.length >= 2) {
            target = Bukkit.getPlayer(args[1]);
            if (target == null) {
                sender.sendMessage(Component.text("‚ùå –ò–≥—Ä–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω!", NamedTextColor.RED));
                return true;
            }
        } else {
            if (!(sender instanceof Player)) {
                sender.sendMessage(Component.text("‚ùå –£–∫–∞–∂–∏—Ç–µ –∏–≥—Ä–æ–∫–∞!", NamedTextColor.RED));
                return true;
            }
            target = (Player) sender;
        }
        
        ItemStack tablet = target.getInventory().getItemInMainHand();
        if (!UraniumTablet.isUraniumTablet(tablet, plugin)) {
            sender.sendMessage(Component.text("‚ùå –£ –∏–≥—Ä–æ–∫–∞ –Ω–µ—Ç –ø–ª–∞–Ω—à–µ—Ç–∞ –≤ —Ä—É–∫–µ!", NamedTextColor.RED));
            return true;
        }
        
        UraniumTablet.TabletType type = UraniumTablet.getTabletType(tablet, plugin);
        if (type == null) {
            sender.sendMessage(Component.text("‚ùå –û—à–∏–±–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ç–∏–ø–∞ –ø–ª–∞–Ω—à–µ—Ç–∞!", NamedTextColor.RED));
            return true;
        }
        
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–ª–∞–Ω—à–µ—Ç –∫ –∑–∞–≤–æ–¥—Å–∫–∏–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º
        ItemStack resetTablet = UraniumTablet.createTablet(plugin, type);
        target.getInventory().setItemInMainHand(resetTablet);
        
        sender.sendMessage(Component.text("‚úÖ –ü–ª–∞–Ω—à–µ—Ç —Å–±—Ä–æ—à–µ–Ω –∫ –∑–∞–≤–æ–¥—Å–∫–∏–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º!", NamedTextColor.GREEN));
        target.sendMessage(Component.text("üîÑ –í–∞—à –ø–ª–∞–Ω—à–µ—Ç –±—ã–ª —Å–±—Ä–æ—à–µ–Ω –∫ –∑–∞–≤–æ–¥—Å–∫–∏–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º!", 
            NamedTextColor.YELLOW));
        
        return true;
    }
    
    private boolean handleListCommand(CommandSender sender) {
        sender.sendMessage(Component.text("üì± –¢–ò–ü–´ –ü–õ–ê–ù–®–ï–¢–û–í", NamedTextColor.AQUA, TextDecoration.BOLD));
        sender.sendMessage(Component.text("‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ", NamedTextColor.DARK_GRAY));
        
        for (UraniumTablet.TabletType type : UraniumTablet.TabletType.values()) {
            sender.sendMessage(Component.text()
                .append(Component.text("‚Ä¢ ", NamedTextColor.GRAY))
                .append(Component.text(type.name().toLowerCase(), type.getColor(), TextDecoration.BOLD))
                .append(Component.text(" - " + type.getDisplayName(), NamedTextColor.WHITE))
                .append(Component.text(" (‚ö°" + type.getMaxEnergy() + ")", NamedTextColor.YELLOW))
                .build());
        }
        
        sender.sendMessage(Component.text("‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ", NamedTextColor.DARK_GRAY));
        return true;
    }
    
    private void showModulesList(CommandSender sender) {
        sender.sendMessage(Component.text("üîß –î–û–°–¢–£–ü–ù–´–ï –ú–û–î–£–õ–ò", NamedTextColor.GOLD, TextDecoration.BOLD));
        sender.sendMessage(Component.text("‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ", NamedTextColor.DARK_GRAY));
        
        for (UraniumTablet.TabletModule module : UraniumTablet.TabletModule.values()) {
            sender.sendMessage(Component.text()
                .append(Component.text("‚Ä¢ ", NamedTextColor.GRAY))
                .append(Component.text(module.name().toLowerCase(), NamedTextColor.AQUA, TextDecoration.BOLD))
                .append(Component.text(" - " + module.getName(), NamedTextColor.WHITE))
                .build());
            sender.sendMessage(Component.text("  " + module.getDescription() + " (‚ö°" + module.getEnergyCost() + ")", 
                NamedTextColor.GRAY));
        }
        
        sender.sendMessage(Component.text("‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ", NamedTextColor.DARK_GRAY));
    }
    
    private void showHelp(CommandSender sender) {
        sender.sendMessage(Component.text("üì± –ö–û–ú–ê–ù–î–´ –ü–õ–ê–ù–®–ï–¢–ê", NamedTextColor.AQUA, TextDecoration.BOLD));
        sender.sendMessage(Component.text("‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ", NamedTextColor.DARK_GRAY));
        sender.sendMessage(Component.text("/tablet give <–∏–≥—Ä–æ–∫> <—Ç–∏–ø> [—ç–Ω–µ—Ä–≥–∏—è] - –í—ã–¥–∞—Ç—å –ø–ª–∞–Ω—à–µ—Ç", NamedTextColor.WHITE));
        sender.sendMessage(Component.text("/tablet info - –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–ª–∞–Ω—à–µ—Ç–µ –≤ —Ä—É–∫–µ", NamedTextColor.WHITE));
        sender.sendMessage(Component.text("/tablet energy <set|add|remove> [–∏–≥—Ä–æ–∫] <–∫–æ–ª-–≤–æ> - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —ç–Ω–µ—Ä–≥–∏–µ–π", NamedTextColor.WHITE));
        sender.sendMessage(Component.text("/tablet module <add|remove|list> [–∏–≥—Ä–æ–∫] [–º–æ–¥—É–ª—å] - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–æ–¥—É–ª—è–º–∏", NamedTextColor.WHITE));
        sender.sendMessage(Component.text("/tablet upgrade - –£–ª—É—á—à–∏—Ç—å –ø–ª–∞–Ω—à–µ—Ç", NamedTextColor.WHITE));
        sender.sendMessage(Component.text("/tablet reset [–∏–≥—Ä–æ–∫] - –°–±—Ä–æ—Å–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏", NamedTextColor.WHITE));
        sender.sendMessage(Component.text("/tablet list - –°–ø–∏—Å–æ–∫ —Ç–∏–ø–æ–≤ –ø–ª–∞–Ω—à–µ—Ç–æ–≤", NamedTextColor.WHITE));
        sender.sendMessage(Component.text("‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ", NamedTextColor.DARK_GRAY));
    }
    
    private NamedTextColor getEnergyColor(int energy, int maxEnergy) {
        double percent = (double) energy / maxEnergy * 100;
        if (percent > 75) return NamedTextColor.GREEN;
        if (percent > 50) return NamedTextColor.YELLOW;
        if (percent > 25) return NamedTextColor.GOLD;
        return NamedTextColor.RED;
    }
    
    @Override
    public List<String> onTabComplete(CommandSender sender, Command command, String alias, String[] args) {
        List<String> completions = new ArrayList<>();
        
        if (args.length == 1) {
            completions.addAll(Arrays.asList("give", "info", "energy", "module", "upgrade", "reset", "list", "help"));
        } else if (args.length == 2) {
            switch (args[0].toLowerCase()) {
                case "give":
                    completions.addAll(getOnlinePlayerNames());
                    break;
                case "energy":
                    completions.addAll(Arrays.asList("set", "add", "remove"));
                    break;
                case "module":
                    completions.addAll(Arrays.asList("add", "remove", "list"));
                    break;
                case "reset":
                    completions.addAll(getOnlinePlayerNames());
                    break;
            }
        } else if (args.length == 3) {
            switch (args[0].toLowerCase()) {
                case "give":
                    completions.addAll(Arrays.asList("standard", "advanced", "quantum", "reality"));
                    break;
                case "energy":
                    if (args[1].equals("set") || args[1].equals("add") || args[1].equals("remove")) {
                        completions.addAll(getOnlinePlayerNames());
                    }
                    break;
                case "module":
                    if (args[1].equals("add") || args[1].equals("remove")) {
                        completions.addAll(getOnlinePlayerNames());
                    }
                    break;
            }
        } else if (args.length == 4) {
            if (args[0].equals("module") && (args[1].equals("add") || args[1].equals("remove"))) {
                for (UraniumTablet.TabletModule module : UraniumTablet.TabletModule.values()) {
                    completions.add(module.name().toLowerCase());
                }
            }
        }
        
        return completions.stream()
            .filter(s -> s.toLowerCase().startsWith(args[args.length - 1].toLowerCase()))
            .sorted()
            .toList();
    }
    
    private List<String> getOnlinePlayerNames() {
        return Bukkit.getOnlinePlayers().stream()
            .map(Player::getName)
            .toList();
    }
}
